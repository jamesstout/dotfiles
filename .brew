#!/usr/bin/env bash
# shellcheck shell=bash
source ./.utils

# Check for Homebrew
if type_exists 'brew'; then
    e_header "Updating Homebrew..."
    # Use the latest version of Homebrew
    brew update
    [[ $? ]] && e_success "Done"

    e_header "Updating any existing Homebrew formulae..."
    # Upgrade any already-installed formulae
    brew upgrade
    [[ $? ]] && e_success "Done"

    e_header "Checking status of desired Homebrew formulae..."
    
    create_formula_list_file

    declare list_formulae
    declare -a missing_formulae=()
    declare -a desired_formulae=(
        'ack'
        'ansiweather'
        'bash'
        'bash-completion@2'
        'binutils'
        'cloc'
        'coreutils' # GNU core utilities (those that come with OS X are outdated)
        'dark-mode'
        'diff-so-fancy'
        'fcrackzip'
        'findutils'
        'fping'
        'gibo'
        'git'
        'git-lfs'
        'git-quick-stats'
        'handbrake'
        'hh'
        'grep'
        'openssh'
        'jq'
        'lesspipe'
        'md5deep'
        'md5sha1sum'
        'moreutils'
        'netperf'
        'ngrep'
        'openssl'
        'p7zip'
        'pigz'
        'pkg-config'
        'pngquant'
        'pstree'
        'pv'
        'python'
        'python3'
        'rbenv'
        'readline'
        'rename'
        'rsync'
        'ruby-build'
        'shellcheck'
        'sqlite'
        'ssh-copy-id'
        'subversion'
        'testssl'
        'texi2html'
        'the_silver_searcher'
        'tidy-html5'
        'tmux'
        'tree'
        'unixodbc'
        'unrar'
        'watchman'
        'webkit2png'
        'wget'
        'x264'
        'xctool'
        'xvid'
        'xz'
        'yasm'
        'youtube-dl'
        'zlib'
        'zopfli'
    )

    for index in ${!desired_formulae[*]}
    do
        if ! formula_exists2 "${desired_formulae[$index]}"; then
            # Store the name (and options) of every missing formula
            missing_formulae=("${missing_formulae[@]}" "${desired_formulae[$index]}")
        fi
    done

    if [[ "${missing_formulae[@]}" ]]; then
        # Convert the array of missing formula into a list of space-separate strings
        list_formulae=$( printf "%s " "${missing_formulae[@]}" )

        e_header "Installing missing Homebrew formulae..."
        # Install all missing formulae
        brew install $list_formulae

        [[ $? ]] && e_success "Done"
    fi


    # Remove outdated versions from the Cellar
    brew cleanup -s
    brew cask cleanup
else
    printf "\n"
    e_error "Error: Homebrew not found."
    printf "Aborting...\n"
    return 1
fi


#
## Install GNU core utilities (those that come with OS X are outdated)
#brew install coreutils
#echo "Don’t forget to add $(brew --prefix coreutils)/libexec/gnubin to \$PATH."
## Install GNU `find`, `locate`, `updatedb`, and `xargs`, g-prefixed
#brew install findutils
## Install Bash 4
#brew install bash
#
## Install wget with IRI support
#brew install wget --enable-iri
#
## Install RingoJS and Narwhal
## Note that the order in which these are installed is important; see http://git.io/brew-narwhal-ringo.
#brew install ringojs
#brew install narwhal
#
## Install more recent versions of some OS X tools
#brew tap homebrew/dupes
#brew install homebrew/dupes/grep
#brew tap josegonzalez/homebrew-php
#brew install php54
#
## These two formulae didn’t work well last time I tried them:
##brew install homebrew/dupes/vim
##brew install homebrew/dupes/screen
#
## Install everything else
#brew install ack
##brew install exiv2
#brew install git
##brew install imagemagick
#brew install lynx
#brew install node
#brew install rename
#brew install rhino
#brew install tree
#brew install webkit2png

#
## Remove outdated versions from the cellar
#brew cleanup

    # brew tap caskroom/cask
    # brew install brew-cask
    # brew tap caskroom/versions

    # # Install packages

    # apps=(
    #   alfred
    #   dash
    #   dropbox
    #   firefox
    #   firefox-nightly
    #   flux
    #   glimmerblocker
    #   google-chrome
    #   google-chrome-canary
    #   google-drive
    #   hammerspoon
    #   kaleidoscope
    #   macdown
    #   opera
    #   screenflow
    #   slack
    #   sourcetree
    #   spotify
    #   sublime-text3
    #   transmit
    #   virtualbox
    #   vlc
    #   webstorm
    # )

    # brew cask install "${apps[@]}"



